<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MEWP Booking ‚Äî View Bookings</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f5f7fb;margin:0}
    .page{max-width:1100px;margin:28px auto;padding:0 16px}
    header{background:#0d47a1;color:#fff;padding:16px;border-radius:10px;text-align:center}
    .controls{display:flex;justify-content:space-between;gap:10px;margin:14px 0;flex-wrap:wrap}
    .btn{background:#1565c0;color:#fff;padding:10px 14px;border-radius:8px;border:none;cursor:pointer}
    .filter{background:#fff;padding:10px;border-radius:8px;box-shadow:0 6px 20px rgba(0,0,0,0.04)}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid #e0e0e0;padding:8px;text-align:left}
    th{background:#1565c0;color:#fff}
    td small{color:#666}
    @media(max-width:720px){.controls{flex-direction:column}}
  </style>
</head>
<body>
  <div class="page">
    <header>MEWP Booking ‚Äî All Bookings (Public View)</header>

    <div class="controls">
      <div>
        <button class="btn" onclick="location.href='index.html'">üîô Back to Book</button>
        <button class="btn" onclick="downloadCSV()">‚¨áÔ∏è Download CSV</button>
      </div>
      <div class="filter">
        Show:
        <select id="viewFilter" onchange="render()">
          <option value="all">All</option>
          <option value="upcoming">Upcoming</option>
          <option value="past">Past</option>
        </select>
      </div>
    </div>

    <div id="tableWrap" class="card"></div>
  </div>

  <script>
    function getBookings(){ return JSON.parse(localStorage.getItem('bookings')||'[]'); }
    function isDatePast(d){ const today = new Date().toISOString().split('T')[0]; return d < today; }

    function render(){
      const bookings = getBookings();
      const filter = document.getElementById('viewFilter').value;
      if(!bookings.length){ document.getElementById('tableWrap').innerHTML = '<p>No bookings yet.</p>'; return; }

      let rows = `<table><tr>
        <th>Purpose</th><th>Dates & Times</th><th>Area</th><th>Department</th><th>Responsible</th><th>Contact</th><th>Status</th><th>Remarks</th><th>Type</th>
      </tr>`;

      const today = new Date().toISOString().split('T')[0];

      bookings.forEach(b=>{
        const anyPast = b.dates.some(d=>d.date < today);
        const type = anyPast ? 'Past' : 'Upcoming';
        if(filter !== 'all' && ((filter==='past' && type!=='Past') || (filter==='upcoming' && type!=='Upcoming'))) return;

        rows += `<tr>
          <td>${escapeHtml(b.purpose)}</td>
          <td>${b.dates.map(d=>escapeHtml(d.date+' ('+d.startTime+' - '+d.endTime+')')).join('<br>')}</td>
          <td>${escapeHtml(b.area)}</td>
          <td>${escapeHtml(b.department)}</td>
          <td>${escapeHtml(b.responsiblePerson)}</td>
          <td>${escapeHtml(b.contact)}</td>
          <td>${escapeHtml(b.status||'Pending')}</td>
          <td>${escapeHtml(b.remarks||'')}</td>
          <td>${type}</td>
        </tr>`;
      });

      rows += '</table>';
      document.getElementById('tableWrap').innerHTML = rows;
    }

    function escapeHtml(s){ return (s||'').toString().replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    function downloadCSV(){
      const bookings = getBookings();
      if(!bookings.length){ return alert('No bookings to download.'); }
      const today = new Date().toISOString().split('T')[0];
      const header = ['Purpose','Dates','Area','Department','Responsible','Contact','Status','Remarks','Type'];
      const rows = bookings.map(b=>{
        const type = b.dates.some(d=>d.date < today) ? 'Past' : 'Upcoming';
        const dates = b.dates.map(d=>`${d.date} (${d.startTime}-${d.endTime})`).join(' | ');
        return [b.purpose, dates, b.area, b.department, b.responsiblePerson, b.contact, b.status||'Pending', b.remarks||'', type];
      });
      const csv = [header,...rows].map(r=>r.map(cell=>'"'+String(cell).replaceAll('"','""')+'"').join(',')).join('\n');
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
      a.download = 'mewp_bookings_public.csv';
      a.click();
    }

    // initial render
    render();
  </script>
</body>
</html>
